/*
 * ap.c
 *
 *  Created on: Dec 6, 2020
 *      Author: baram
 */


#include "ap.h"
#include "lcd/st7735.h"


typedef struct
{
  uint32_t pre_time;
  uint16_t x_time;
  uint8_t  mode;
} args_t;


LCD_IMAGE_DEF(img_logo);


void apInit(void)
{
	//uartOpen(_DEF_UART1, 57600);
	  cliOpen(_DEF_UART1, 57600);

	  //st7735Init();
	  //gpioPinWrite(1, _DEF_HIGH);

}

void apMain(void)
{

  uint32_t pre_time;
  args_t args;

  args.mode = 0;
  args.x_time = 0;
  args.pre_time = millis();

  pre_time = millis();
  while(1)
  {
    if (millis()-pre_time >= 500)
    {
      pre_time = millis();
      ledToggle(_DEF_LED1);
    }

    /*// CDC TEST
    if(uartAvailable(_DEF_UART1) > 0)
    {
    	uartPrintf(_DEF_UART1, "Rx 0x%X\n",uartRead(_DEF_UART1));
    }
    */

    cliMain();
    lcdMain(&args);
  }
}





void lcdMain(args_t *p_args)
{
	if (lcdIsInit() != true)
	{
	  return;
	}

	if (millis()-p_args->pre_time >= (1000/30) && lcdDrawAvailable() == true)
	{
	  p_args->pre_time = millis();

	  lcdClearBuffer(black);

	  uint16_t x1 = 0;
	  uint16_t x2 = 0;


	  if (buttonGetPressed(_DEF_BUTTON1))
	  {
	    p_args->mode = (p_args->mode + 1)%2;
	    delay(200);
	  }
	  if (p_args->mode == 0)
	  {
	    p_args->x_time += 2;

      x1 = p_args->x_time;
      x1 %= (LCD_WIDTH - img_logo.header.w);;


      lcdDrawImage(x1, 0, &img_logo);
	  }

    if (p_args->mode == 1)
    {
      lcdPrintfResize(0,16, green, 32, "Mode 1");
    }

	  lcdRequestDraw();
  }
}
